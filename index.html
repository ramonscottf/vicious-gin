<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vicious Gin - Gem Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #050510;
            color: #e2e8f0;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(120px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
        }

        .gem-gradient {
            background: linear-gradient(to right, #4f46e5, #9333ea, #db2777);
        }

        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(147, 51, 234, 0.1), transparent);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .winner-glow {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.5);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
        }

        .loser-glow {
            background: rgba(244, 63, 94, 0.1);
            border-color: rgba(244, 63, 94, 0.5);
            box-shadow: 0 0 20px rgba(244, 63, 94, 0.2);
        }
    </style>
</head>
<body class="overflow-x-hidden selection:bg-purple-500/30">
    <!-- Background Glows -->
    <div class="fixed top-[-10%] left-[-10%] w-[50%] h-[50%] bg-indigo-600/10 blur-[120px] rounded-full pointer-events-none"></div>
    <div class="fixed bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-purple-600/10 blur-[120px] rounded-full pointer-events-none"></div>

    <div class="max-w-md mx-auto px-4 pt-6 pb-32 relative z-10">
        <!-- Header -->
        <header class="mb-8 space-y-4">
            <div class="flex justify-between items-center mb-2">
                <h1 class="text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-500 tracking-tight">
                    VICIOUS GIN
                </h1>
                <button onclick="resetGame()" class="p-2 rounded-full bg-white/5 hover:bg-white/10">
                    <i data-lucide="rotate-ccw" class="w-5 h-5 text-slate-400"></i>
                </button>
            </div>
            
            <div id="score-banner" class="grid grid-cols-3 gap-3">
                <!-- Scores injected here -->
            </div>
        </header>

        <!-- Main Tabs -->
        <main id="main-content">
            <!-- Input Tab -->
            <section id="tab-input" class="tab-content active space-y-6">
                <div class="glass-card p-6">
                    <div class="flex justify-between mb-8">
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Player</span>
                            <select id="input-player" onchange="syncUI()" class="bg-transparent text-xl font-black text-white outline-none border-b-2 border-purple-500/30 focus:border-purple-500 transition-all">
                                <option value="Sasha" class="bg-slate-900">Sasha</option>
                                <option value="Scott" class="bg-slate-900">Scott</option>
                                <option value="Charles" class="bg-slate-900">Charles</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-1 text-right max-w-[50%]">
                            <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Hand Req</span>
                            <select id="input-hand-idx" onchange="syncUI()" class="bg-transparent text-sm font-bold text-slate-300 outline-none text-right">
                                <!-- Options injected here -->
                            </select>
                        </div>
                    </div>

                    <div class="flex flex-col items-center gap-2 mb-8">
                        <div class="flex items-center gap-8">
                            <button onclick="adjustScore(-5)" class="w-14 h-14 rounded-full bg-white/5 border border-white/10 flex items-center justify-center hover:bg-white/10 active:scale-90 transition-all">
                                <i data-lucide="chevron-down" class="w-8 h-8"></i>
                            </button>
                            <div id="display-score" class="text-8xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-b from-white to-slate-500 tabular-nums">
                                0
                            </div>
                            <button onclick="adjustScore(5)" class="w-14 h-14 rounded-full bg-white/5 border border-white/10 flex items-center justify-center hover:bg-white/10 active:scale-90 transition-all">
                                <i data-lucide="chevron-up" class="w-8 h-8"></i>
                            </button>
                        </div>
                    </div>

                    <div id="point-buttons" class="grid grid-cols-3 gap-2 mb-8">
                        <!-- Points injected here -->
                    </div>

                    <div class="space-y-3">
                        <label class="flex flex-col items-center justify-center p-6 border-2 border-dashed border-white/10 rounded-2xl cursor-pointer hover:bg-white/5 hover:border-purple-500/50 transition-all group overflow-hidden relative">
                            <input type="file" capture="environment" accept="image/*" class="hidden" onchange="handleScan(this)">
                            <div class="flex items-center gap-3 relative z-10">
                                <i id="scan-icon" data-lucide="camera" class="text-purple-400 group-hover:scale-110 transition-transform"></i>
                                <span id="scan-text" class="font-bold">Scan with Gemini</span>
                            </div>
                            <div id="scan-shimmer" class="hidden absolute inset-0 shimmer translate-x-0"></div>
                        </label>
                        
                        <button onclick="submitScore()" class="w-full flex items-center justify-center gap-2 py-5 rounded-2xl font-bold transition-all active:scale-95 gem-gradient text-white shadow-xl shadow-purple-900/40">
                            Log Result <i data-lucide="check-circle-2" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <div id="status-msg" class="hidden mt-4 flex items-center justify-center gap-2 text-xs font-bold text-purple-400">
                        <i data-lucide="sparkles" class="w-3.5 h-3.5"></i> <span id="status-text"></span>
                    </div>
                </div>
            </section>

            <!-- Guide Tab -->
            <section id="tab-guide" class="tab-content space-y-6">
                <div class="grid gap-3" id="guide-list">
                    <!-- Guide items injected here -->
                </div>
            </section>

            <!-- Board Tab -->
            <section id="tab-board" class="tab-content space-y-4">
                <div class="glass-card overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-white/5">
                            <tr id="table-head">
                                <th class="p-4 text-[10px] font-black text-slate-500 uppercase">Requirement</th>
                                <!-- Player headers injected -->
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-white/5">
                            <!-- Rows injected -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>

        <!-- Nav Dock -->
        <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-sm h-20 bg-[#151525]/80 backdrop-blur-2xl border border-white/10 rounded-3xl flex items-center justify-around px-2 shadow-2xl z-50">
            <button onclick="setTab('guide')" id="nav-guide" class="flex flex-col items-center gap-1.5 p-3 transition-all text-slate-500">
                <i data-lucide="layout-grid" class="w-6 h-6"></i>
                <span class="text-[8px] font-black uppercase tracking-widest">Guide</span>
            </button>
            
            <button onclick="setTab('input')" id="nav-input" class="relative -top-6 w-16 h-16 rounded-full flex items-center justify-center transition-all bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 shadow-[0_8px_25px_rgba(168,85,247,0.4)]">
                <i data-lucide="plus" class="w-8 h-8 text-white"></i>
            </button>
            
            <button onclick="setTab('history')" id="nav-history" class="flex flex-col items-center gap-1.5 p-3 transition-all text-slate-500">
                <i data-lucide="history" class="w-6 h-6"></i>
                <span class="text-[8px] font-black uppercase tracking-widest">Board</span>
            </button>
        </nav>
    </div>

    <script>
        const HAND_REQUIREMENTS = [
            "2 sets of 3", "1 set of 3, 1 run of 4", "2 Runs of 4", "3 sets of 3",
            "1 set of 3, 1 run of 7", "2 sets of 3, 1 run of 5", "3 runs of 4",
            "1 set of 3, 1 run of 10", "3 sets of 3, 1 run of 5", "3 runs of 5"
        ];

        const POINT_RULES = {
            '3-9': 5, '10-K': 10, 'Ace': 15, '2': 25, 'Joker': 50, 'Other': 25
        };

        let state = {
            players: ['Sasha', 'Scott', 'Charles'],
            gameData: HAND_REQUIREMENTS.map(h => ({ name: h, scores: { Sasha: null, Scott: null, Charles: null } })),
            currentHandIdx: 0,
            currentPlayer: 'Sasha',
            manualScore: 0,
            isScanning: false
        };

        const apiKey = ""; // Runtime provided

        function init() {
            lucide.createIcons();
            
            // Populate Hand Selection
            const select = document.getElementById('input-hand-idx');
            HAND_REQUIREMENTS.forEach((h, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.className = "bg-slate-900";
                opt.textContent = `${i + 1}. ${h}`;
                select.appendChild(opt);
            });

            // Populate Point Buttons
            const btnContainer = document.getElementById('point-buttons');
            Object.entries(POINT_RULES).forEach(([label, pts]) => {
                const btn = document.createElement('button');
                btn.className = "py-2.5 px-1 bg-white/5 border border-white/5 rounded-xl hover:bg-white/10 transition-all flex flex-col items-center";
                btn.innerHTML = `<span class="text-[10px] font-bold text-slate-500 uppercase">${label}</span><span class="text-sm font-black text-slate-200">+${pts}</span>`;
                btn.onclick = () => { state.manualScore += pts; syncUI(); };
                btnContainer.appendChild(btn);
            });

            syncUI();
        }

        function syncUI() {
            state.currentPlayer = document.getElementById('input-player').value;
            state.currentHandIdx = parseInt(document.getElementById('input-hand-idx').value);
            document.getElementById('display-score').textContent = state.manualScore;

            updateScoreBanner();
            renderGuide();
            renderBoard();
            updateNav();
        }

        function updateScoreBanner() {
            const totals = state.players.map(p => ({
                name: p,
                total: state.gameData.reduce((sum, h) => sum + (h.scores[p] || 0), 0)
            }));
            
            const sorted = [...totals].sort((a, b) => a.total - b.total);
            const winner = sorted[0].total > 0 ? sorted[0].name : null;
            const loser = sorted[sorted.length-1].total > 0 ? sorted[sorted.length-1].name : null;

            const banner = document.getElementById('score-banner');
            banner.innerHTML = totals.map(t => `
                <div class="relative p-3 rounded-2xl border transition-all duration-700 ${t.name === winner ? 'winner-glow' : t.name === loser ? 'loser-glow' : 'bg-white/5 border-white/10'}">
                    <div class="text-[10px] uppercase font-black tracking-widest opacity-50 mb-1">${t.name}</div>
                    <div class="text-2xl font-black tabular-nums">${t.total}</div>
                    ${t.name === winner ? '<i data-lucide="sparkles" class="absolute top-2 right-2 text-emerald-400 w-3 h-3 animate-pulse"></i>' : ''}
                    ${t.name === loser ? '<i data-lucide="zap" class="absolute top-2 right-2 text-rose-400 w-3 h-3"></i>' : ''}
                </div>
            `).join('');
            lucide.createIcons();
        }

        function adjustScore(v) {
            state.manualScore = Math.max(0, state.manualScore + v);
            syncUI();
        }

        function setTab(tab) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (tab === 'history') document.getElementById('tab-board').classList.add('active');
            else document.getElementById(`tab-${tab}`).classList.add('active');
            syncUI();
        }

        function updateNav() {
            const active = Array.from(document.querySelectorAll('.tab-content')).find(c => c.classList.contains('active')).id;
            const navId = active === 'tab-board' ? 'nav-history' : active === 'tab-guide' ? 'nav-guide' : 'nav-input';
            
            ['nav-guide', 'nav-history'].forEach(id => {
                const btn = document.getElementById(id);
                btn.classList.toggle('text-purple-400', id === navId);
                btn.classList.toggle('scale-110', id === navId);
                btn.classList.toggle('text-slate-500', id !== navId);
            });
        }

        function renderGuide() {
            const container = document.getElementById('guide-list');
            container.innerHTML = `
                <div class="p-1 px-3 bg-white/5 border border-white/10 rounded-full inline-flex items-center gap-2 w-fit mb-2">
                    <i data-lucide="info" class="w-3.5 h-3.5 text-purple-400"></i>
                    <span class="text-[10px] font-bold uppercase tracking-wider text-slate-400">Hand Progress</span>
                </div>
            ` + state.gameData.map((h, i) => {
                const isDone = state.players.every(p => h.scores[p] !== null);
                const isCurrent = i === state.currentHandIdx;
                return `
                    <div class="glass-card p-4 flex items-center justify-between border-l-4 transition-all ${isDone ? 'border-l-emerald-500 opacity-60' : isCurrent ? 'border-l-purple-500 bg-purple-500/5' : 'border-l-transparent'}">
                        <div class="flex items-center gap-4">
                            <span class="w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-black ${isDone ? 'bg-emerald-500/20 text-emerald-400' : 'bg-white/10 text-slate-400'}">${i+1}</span>
                            <span class="font-bold text-sm ${isCurrent ? 'text-white' : 'text-slate-400'}">${h.name}</span>
                        </div>
                        ${isDone ? '<i data-lucide="check-circle-2" class="w-4 h-4 text-emerald-500"></i>' : ''}
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function renderBoard() {
            const head = document.getElementById('table-head');
            head.innerHTML = `<th class="p-4 text-[10px] font-black text-slate-500 uppercase">Requirement</th>` + 
                state.players.map(p => `<th class="p-4 text-[10px] font-black text-slate-500 uppercase text-center">${p}</th>`).join('');

            const body = document.getElementById('table-body');
            body.innerHTML = state.gameData.map((h, i) => `
                <tr class="${i === state.currentHandIdx ? 'bg-purple-500/5' : ''}">
                    <td class="p-4">
                        <div class="text-[10px] text-slate-500 font-bold mb-1">Round ${i+1}</div>
                        <div class="text-sm font-semibold leading-tight">${h.name}</div>
                    </td>
                    ${state.players.map(p => `
                        <td class="p-4 text-center">
                            <input type="number" onchange="manualTableUpdate(${i}, '${p}', this.value)" 
                                value="${h.scores[p] ?? ''}" placeholder="-"
                                class="w-12 bg-white/5 border border-white/5 rounded-lg text-center p-1 font-bold text-white focus:border-purple-500 outline-none transition-all">
                        </td>
                    `).join('')}
                </tr>
            `).join('');
        }

        function manualTableUpdate(idx, player, val) {
            state.gameData[idx].scores[player] = val === "" ? null : parseInt(val);
            updateScoreBanner();
        }

        function submitScore() {
            state.gameData[state.currentHandIdx].scores[state.currentPlayer] = state.manualScore;
            showStatus(`Logged ${state.manualScore} for ${state.currentPlayer}`);
            state.manualScore = 0;

            const pIdx = state.players.indexOf(state.currentPlayer);
            if (pIdx < state.players.length - 1) {
                state.currentPlayer = state.players[pIdx + 1];
            } else {
                state.currentPlayer = state.players[0];
                if (state.currentHandIdx < HAND_REQUIREMENTS.length - 1) state.currentHandIdx++;
            }

            document.getElementById('input-player').value = state.currentPlayer;
            document.getElementById('input-hand-idx').value = state.currentHandIdx;
            syncUI();
        }

        function showStatus(txt) {
            const el = document.getElementById('status-msg');
            document.getElementById('status-text').textContent = txt;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }

        async function handleScan(input) {
            const file = input.files[0];
            if (!file) return;

            state.isScanning = true;
            document.getElementById('scan-icon').classList.add('animate-spin');
            document.getElementById('scan-text').textContent = "Analyzing Hand...";
            document.getElementById('scan-shimmer').classList.remove('hidden');

            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64 = reader.result.split(',')[1];
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: "Sum card values for Vicious Gin. Rules: 3-9=5pt, 10-K=10pt, Ace=15pt, 2=25pt, Joker=50pt, others=25pt. Return JSON: {total: number, cardsFound: string}" },
                                    { inlineData: { mimeType: "image/png", data: base64 } }
                                ]
                            }]
                        })
                    });
                    const res = await response.json();
                    const text = res.candidates[0].content.parts[0].text;
                    const match = text.match(/\{.*\}/s);
                    if (match) {
                        const data = JSON.parse(match[0]);
                        state.manualScore = data.total;
                        showStatus(`Detected: ${data.cardsFound}`);
                        syncUI();
                    }
                } catch (e) {
                    showStatus("Scan failed. Use manual input.");
                } finally {
                    state.isScanning = false;
                    document.getElementById('scan-icon').classList.remove('animate-spin');
                    document.getElementById('scan-text').textContent = "Scan with Gemini";
                    document.getElementById('scan-shimmer').classList.add('hidden');
                }
            };
            reader.readAsDataURL(file);
        }

        function resetGame() {
            if (confirm("Reset current game scores?")) {
                state.gameData.forEach(h => {
                    state.players.forEach(p => h.scores[p] = null);
                });
                state.manualScore = 0;
                syncUI();
            }
        }

        window.onload = init;
    </script>
</body>
</html>
